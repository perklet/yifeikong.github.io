<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Yifei Kong | articles tagged "计算机" | Page 4</title>
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link href="/feed/atom-all.xml" type="application/atom+xml" rel="alternate" title="Yifei Kong Full Atom Feed" />
    <link href="/feed/rss-all.xml" type="application/rss+xml" rel="alternate" title="Yifei Kong Full RSS Feed" />
    <link href="/feed/atom.xml" type="application/atom+xml" rel="alternate" title="Yifei Kong Atom Feed" />
    <link href="/feed/rss.xml" type="application/rss+xml" rel="alternate" title="Yifei Kong RSS Feed" />
    <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="/theme/css/pygments.css" type="text/css" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Yifei Kong" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="/tag/ji-suan-ji/page/4/index.html">计算机</a></li>
                <li><a href="/">Home</a></li>
                <li><a href="https://github.com/">GitHub</a></li>
                <li><a href="/tags">Tags</a></li>
                <li><a href="/categories">Categories</a></li>
                <li><a href="/archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="/">Yifei Kong</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Aug 01, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/tu-jie-yi-zhi-xing-ha-xi.html" rel="bookmark" title="Permanent Link to &quot;图解一致性哈希&quot;">图解一致性哈希</a>
                </h2>

                
                

                <h1>起源</h1>
<p>比如你有 N 个 cache 服务器（后面简称 cache ），那么如何将一个对象 object 映射到 N 个 cache 上呢，你很可能会采用类似下面的通用方法计算 object 的 hash 值，然后均匀的映射到到 N 个 cache ；</p>
<div class="highlight"><pre><span></span>hash(object) % N
</pre></div>


<p>一切都运行正常，再考虑如下的两种情况；</p>
<ol>
<li>
<p>一个 cache 服务器 m down 掉了（在实际应用中必须要考虑这种情况），这样所有映射到 cache m 的对象都会失效，怎么办，需要把 cache m 从 cache 中移除，这时候 cache 是 …</p></li></ol>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/tu-jie-yi-zhi-xing-ha-xi.html">posted at 05:43</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/suan-fa.html" class="tags">算法</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 31, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/ha-shi-yao-shi-raft-xie-yi.html" rel="bookmark" title="Permanent Link to &quot;蛤？什么是 raft 协议？&quot;">蛤？什么是 raft 协议？</a>
                </h2>

                
                

                <p>Raft 协议是一个分布式的一致性协议，主要通过 Leader Election 和 Log Replication 两个步骤来实现高可用的一致性状态存储。</p>
<p>这篇文章并不是 Raft 协议的一个完整介绍，只是其中核心概念的一个总结概括，要完全理解所有细节还是得看论文。</p>
<h1>Leader 选举</h1>
<ol>
<li>每个节点有三种状态：follower、candidate、leader。</li>
<li>作为 leader 有任期(term)的概念，根据基本法必须选举上台。Term 是一个自增的数字。</li>
<li>作为 leader 要不断发送心跳给 follower，告诉他们一律不得经商。</li>
<li>所有节点都有一个随机的定时器（150ms~300ms），当 follower 没有收到日志后就会升级为 candidate，term + 1，给自己投一票，并且发送 Request Vote RPC 给所有节点，也就是 apply …</li></ol>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/ha-shi-yao-shi-raft-xie-yi.html">posted at 18:59</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/suan-fa.html" class="tags">算法</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 31, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/lsm-he-sstable.html" rel="bookmark" title="Permanent Link to &quot;LSM 和 sstable&quot;">LSM 和 sstable</a>
                </h2>

                
                

                <h1>核心要点</h1>
<p>lsm 是 bigtable、leveldb、rocksdb 等数据库采用的算法。</p>
<p>硬盘，尤其是机械硬盘，顺序写入性能远大于随机写入性能，所以 lsm 把大量的随机写入抓换成了顺序写入，从而极大地又花了写入能力。同时查找效率收到了损伤。</p>
<p>适用于顺序写入多，随机读取少的场景。</p>
<p>之所以要使用 Immutable Memtable，就是为了避免将 MemTable 中的内容序列化到磁盘中时会阻塞写操作。</p>
<h2>操作</h2>
<ol>
<li>插入</li>
</ol>
<p>写入 WAL，然后操作 memtable。WAL 是顺序读写，而memtable 是跳表，操作都很迅速</p>
<ol>
<li>更新</li>
</ol>
<p>和插入其实是一样的操作</p>
<ol>
<li>删除</li>
</ol>
<p>插入一条特殊的删除日志，在 memtable 中标记删除</p>
<ol>
<li>compaction（压缩）</li>
</ol>
<p>当 memtable 达到设定的阈值的时候，会写入到 immutable memtable，然后写入到硬盘上的 …</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/lsm-he-sstable.html">posted at 10:00</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/suan-fa.html" class="tags">算法</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 26, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/hong-hei-shu.html" rel="bookmark" title="Permanent Link to &quot;红黑树&quot;">红黑树</a>
                </h2>

                
                

                <p>红黑树的要求：</p>
<ol>
<li>节点是红色或黑色。</li>
<li>根是黑色。</li>
<li>所有叶子都是黑色（叶子是NIL节点）。</li>
<li>每个红色节点必须有两个黑色的子节点。（从每个叶子到根的所有路径上不能有两个连续的红色节点。）</li>
<li>从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。</li>
</ol>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Red-black_tree_example.svg/900px-Red-black_tree_example.svg.png"></p>
<p>两篇不错的教程：</p>
<ol>
<li><a href="https://juejin.im/post/5a27c6946fb9a04509096248">漫画：什么是红黑树</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91">维基上的红黑树</a></li>
</ol>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/hong-hei-shu.html">posted at 18:37</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/suan-fa.html" class="tags">算法</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 24, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/mysql-xing-neng-xiao-ji-qiao-he-zai-django-zhong-de-ying-yong.html" rel="bookmark" title="Permanent Link to &quot;MySQL 性能小技巧和在 Django 中的应用&quot;">MySQL 性能小技巧和在 Django 中的应用</a>
                </h2>

                
                

                <h1>1. 拆分影响很多行的语句</h1>
<p>对于 delete update insert 等语句一定要使用 limit 子句限制影响的行数，避免一次更改特别多的行，造成数据库假死</p>
<div class="highlight"><pre><span></span>while (1) {
    //每次只做1000条
    mysql_query(&quot;DELETE FROM logs WHERE log_date &lt;= &#39;2009-11-01&#39; LIMIT 1000&quot;);
    if (mysql_affected_rows() == 0) {
        // 没得可删了，退出！
        break;
    }
    // 每次都要休息一会儿
    usleep(50000);
}
</pre></div>


<h1>2. 垂直分割</h1>
<p>把不会用作索引的，或者是过长的字段可以考虑使用其他存储引擎，比如 rocksdb 等。</p>
<h1>3. IPv4 地址可以存为 uint32</h1>
<p>使用 uint32 存储 IP 地址不光可以节省空间，而且可以按区间查询。</p>
<h1>4 …</h1>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/mysql-xing-neng-xiao-ji-qiao-he-zai-django-zhong-de-ying-yong.html">posted at 08:11</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/shu-ju-ku.html" class="tags">数据库</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 23, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/mei-ge-cheng-xu-yuan-du-ying-gai-zhi-dao-de-yan-chi-shu-zi.html" rel="bookmark" title="Permanent Link to &quot;每个程序员都应该知道的延迟数字&quot;">每个程序员都应该知道的延迟数字</a>
                </h2>

                
                

                <table>
<thead>
<tr>
<th>动作</th>
<th>时间</th>
<th>换算</th>
</tr>
</thead>
<tbody>
<tr>
<td>L1 缓存访问</td>
<td>0.5 ns</td>
<td>0.5ns</td>
</tr>
<tr>
<td>分支预测错误</td>
<td>5 ns</td>
<td>5ns</td>
</tr>
<tr>
<td>L2 缓存访问</td>
<td>7 ns</td>
<td>7ns</td>
</tr>
<tr>
<td>互斥锁/解锁</td>
<td>25 ns</td>
<td>25ns</td>
</tr>
<tr>
<td>内存访问</td>
<td>100 ns</td>
<td>100ns</td>
</tr>
<tr>
<td>使用 Zippy压缩 1KiB</td>
<td>3,000 ns</td>
<td>3 µs</td>
</tr>
<tr>
<td>通过 1 Gbps 网络发送 2KiB</td>
<td>20,000 ns</td>
<td>20 µs</td>
</tr>
<tr>
<td>SSD 随机读取</td>
<td>150,000 …</td></tr></tbody></table>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/mei-ge-cheng-xu-yuan-du-ying-gai-zhi-dao-de-yan-chi-shu-zi.html">posted at 02:32</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 23, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/mysql-de-wait_timeout-wen-ti.html" rel="bookmark" title="Permanent Link to &quot;Mysql 的 wait_timeout 问题&quot;">Mysql 的 wait_timeout 问题</a>
                </h2>

                
                

                <p>Mysql 中默认的 wait_timeout 和 interactive_timeout 的值是八小时，也就是一个连接（交互式和非交互式的）只有在 8 小时没有活动之后才会被关闭掉。对于互联网公司来说，这个值实在太大了，一个库可能被很多脚本和服务访问，可能只是一个简短的查询就不需要数据库了，如果每个查询都占据了8小时的时间，那么 mysql 很快连接数就会满了，报出 too many connections 错误。</p>
<p>mysql 默认的连接数可以修改 max_connections 参数，但是一个服务器能支撑的连接数显然是由硬件决定的。</p>
<p>设置 wait_timeout 过短可能会造成一些问题，如果在 django 中两次查询的之间时间大于 wait_timeout，就会报 (2006, 'MySQL server has gone away')。django 官方给的建议是：</p>
<ol>
<li>当你的脚本不需要使用数据库的时候，主动关闭连接 <code>from django.db …</code></li></ol>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/mysql-de-wait_timeout-wen-ti.html">posted at 02:28</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/shu-ju-ku.html" class="tags">数据库</a>
                    &nbsp;<a href="/tag/django.html" class="tags">Django</a>
                    &nbsp;<a href="/tag/hou-duan.html" class="tags">后端</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 23, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/dong-tai-gui-hua-leetcode-413-arithmetic-slices.html" rel="bookmark" title="Permanent Link to &quot;动态规划（LeetCode 413. Arithmetic Slices）&quot;">动态规划（LeetCode 413. Arithmetic Slices）</a>
                </h2>

                
                

                <h1>LeetCode 413. Arithmetic Slice</h1>
<p>是一道可以用动态规划解的问题</p>
<h2>题目</h2>
<p>给定一个数组，找出其中等差数列的个数。等差数列的定义：3各元素以上，每个元素之间差相等。</p>
<p>比如：</p>
<div class="highlight"><pre><span></span>1, 3, 5, 7, 9
7, 7, 7, 7
3, -1, -5, -9
</pre></div>


<p>下面的就不是：</p>
<div class="highlight"><pre><span></span>1, 1, 2, 5, 7
</pre></div>


<p>例子：</p>
<div class="highlight"><pre><span></span>A = [1, 2, 3, 4]

return: 3, for 3 arithmetic slices in A: [1, 2, 3], [2, 3 …</pre></div>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/dong-tai-gui-hua-leetcode-413-arithmetic-slices.html">posted at 01:12</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/suan-fa.html" class="tags">算法</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 20, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/redis-chang-jian-wen-ti.html" rel="bookmark" title="Permanent Link to &quot;redis 常见问题&quot;">redis 常见问题</a>
                </h2>

                
                

                <p>主要参考这篇文章：https://mp.weixin.qq.com/s/vS8IMgBIrfGpZYNUwtXrPQ</p>
<h1>1. 集合操作避免范围过大</h1>
<p>使用 sortedset、set、list、hash等集合类的O(N)操作时要评估当前元素个数的规模以及将来的增长规模，对于短期就可能变为大集合的key，要预估O(N)操作的元素数量，避免全量操作，可以使用HSCAN、SSCAN、ZSCAN进行渐进操作。集合元素数量过大在使用过程中会影响redis的实际性能，元素个数建议尽量不要超过5000，元素数量过大可考虑拆分成多个key进行处理。</p>
<h1>2. 合理使用过期时间</h1>
<p>如果key没有设置超时时间，会导致一直占用内存。对于可以预估使用生命周期的key应当设置合理的过期时间或在最后一次操作时进行清理，避免垃圾数据残留redis。redis 不是垃圾桶。</p>
<h1>3. 利用批量操作命令</h1>
<p>假设要给一个集合导入 5000 个元素：</p>
<p>方案1：直接使用redis的HSET逐个设置</p>
<div class="highlight"><pre><span></span>for _ in 0..5000
    HSET hash …</pre></div>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/redis-chang-jian-wen-ti.html">posted at 04:03</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/shu-ju-ku.html" class="tags">数据库</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>            <h4 class="date">Jul 20, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/posts/da-gui-mo-zi-fu-chuan-de-pi-pei.html" rel="bookmark" title="Permanent Link to &quot;大规模字符串的匹配&quot;">大规模字符串的匹配</a>
                </h2>

                
                

                <p>问题：假设我们有一组比较长的文本，每一个文本都有几十k左右，还有一些敏感关键词需要删除，大概有几千，然后需要在这些文本中把关键词找出来。</p>
<h1>方法1：暴力搜索</h1>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="n">compiled_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">my20000words</span><span class="p">]</span>

<span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">compiled_words</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;***&quot;</span><span class="p">,</span> <span class="n">sentence</span><span class="p">))</span>
</pre></div>


<h1>改进1：把正则组合起来</h1>
<div class="highlight"><pre><span></span>pattern = &quot;\b(word1|word2|word3)\b&quot;

for sentence in sentences:
  print(re.sub …</pre></div>
                <div class="clear"></div>

                <div class="info">
                    <a href="/posts/da-gui-mo-zi-fu-chuan-de-pi-pei.html">posted at 02:35</a>
                    &nbsp;&middot;&nbsp;<a href="/category/ji-suan-ji.html" rel="tag">计算机</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/suan-fa.html" class="tags">算法</a>
                    &nbsp;<a href="/tag/ji-suan-ji.html" class="tags selected">计算机</a>
                </div>
            </article>

                <div class="clear"></div>
                <div class="pages">

                    <a href="/page/3" class="prev_page">&larr;&nbsp;Previous</a>
                    <a href="/page/5" class="next_page">Next&nbsp;&rarr;</a>
                    <span>Page 4 of 30</span>
                </div>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="/feed/atom-all.xml" rel="alternate">Atom Feed</a>
                &middot;
                <a href="/feed/rss-all.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>